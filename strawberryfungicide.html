<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.40">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Strawberry Fungicide Analysis</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
</style>


<script src="strawberryfungicide_files/libs/clipboard/clipboard.min.js"></script>
<script src="strawberryfungicide_files/libs/quarto-html/quarto.js"></script>
<script src="strawberryfungicide_files/libs/quarto-html/popper.min.js"></script>
<script src="strawberryfungicide_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="strawberryfungicide_files/libs/quarto-html/anchor.min.js"></script>
<link href="strawberryfungicide_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="strawberryfungicide_files/libs/quarto-html/quarto-syntax-highlighting-549806ee2085284f45b00abea8c6df48.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="strawberryfungicide_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="strawberryfungicide_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="strawberryfungicide_files/libs/bootstrap/bootstrap-8a79a254b8e706d3c925cde0a310d4f0.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">


</head>

<body class="fullcontent">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Strawberry Fungicide Analysis</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p>#First, take a look at the data from NASS</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 758
Columns: 21
$ Program          &lt;chr&gt; "SURVEY", "SURVEY", "SURVEY", "SURVEY", "SURVEY", "SU…
$ Year             &lt;int&gt; 2023, 2023, 2023, 2023, 2023, 2023, 2023, 2023, 2023,…
$ Period           &lt;chr&gt; "YEAR", "YEAR", "YEAR", "YEAR", "YEAR", "YEAR", "YEAR…
$ Week.Ending      &lt;lgl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, N…
$ Geo.Level        &lt;chr&gt; "STATE", "STATE", "STATE", "STATE", "STATE", "STATE",…
$ State            &lt;chr&gt; "CALIFORNIA", "CALIFORNIA", "CALIFORNIA", "CALIFORNIA…
$ State.ANSI       &lt;int&gt; 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6,…
$ Ag.District      &lt;lgl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, N…
$ Ag.District.Code &lt;lgl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, N…
$ County           &lt;lgl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, N…
$ County.ANSI      &lt;lgl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, N…
$ Zip.Code         &lt;lgl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, N…
$ Region           &lt;lgl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, N…
$ watershed_code   &lt;int&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,…
$ Watershed        &lt;lgl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, N…
$ Commodity        &lt;chr&gt; "STRAWBERRIES", "STRAWBERRIES", "STRAWBERRIES", "STRA…
$ Data.Item        &lt;chr&gt; "STRAWBERRIES - APPLICATIONS, MEASURED IN LB / ACRE /…
$ Domain           &lt;chr&gt; "CHEMICAL, FUNGICIDE", "CHEMICAL, FUNGICIDE", "CHEMIC…
$ Domain.Category  &lt;chr&gt; "CHEMICAL, FUNGICIDE: (OXATHIAPIPROLIN = 128111)", "C…
$ Value            &lt;chr&gt; " (D)", " (D)", " (D)", "0.326", " (NA)", " (NA)", " …
$ CV....           &lt;lgl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, N…</code></pre>
</div>
</div>
<p>#After scan the dataset, we noticed there are a lot of empty cols, so we decide to clean up these cols.</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>[1] "col dropped:"
 [1] "Program"          "Period"           "Week.Ending"      "Geo.Level"       
 [5] "Ag.District"      "Ag.District.Code" "County"           "County.ANSI"     
 [9] "Zip.Code"         "Region"           "watershed_code"   "Watershed"       
[13] "Commodity"        "Domain"           "CV...."          </code></pre>
</div>
</div>
<p>#Then, check if there are other strange values</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 758
Columns: 6
$ Year            &lt;int&gt; 2023, 2023, 2023, 2023, 2023, 2023, 2023, 2023, 2023, …
$ State           &lt;chr&gt; "CALIFORNIA", "CALIFORNIA", "CALIFORNIA", "CALIFORNIA"…
$ State.ANSI      &lt;int&gt; 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, …
$ Data.Item       &lt;chr&gt; "STRAWBERRIES - APPLICATIONS, MEASURED IN LB / ACRE / …
$ Domain.Category &lt;chr&gt; "CHEMICAL, FUNGICIDE: (OXATHIAPIPROLIN = 128111)", "CH…
$ Value           &lt;chr&gt; " (D)", " (D)", " (D)", "0.326", " (NA)", " (NA)", " (…</code></pre>
</div>
</div>
<p>#Some of the values are labeled as (D), which means they were withheld to avoid disclosing data for individual operations. #These entries are removed to retain only the usable and publicly available data for analysis.</p>
<p>#Lastly, separate Domain.category and Data.item to get a clearer data set</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>  Year      State State.ANSI          Chem_Group         Fungicide   Code
1 2023 CALIFORNIA          6 CHEMICAL, FUNGICIDE      AZOXYSTROBIN 128810
2 2023 CALIFORNIA          6 CHEMICAL, FUNGICIDE BORAX DECAHYDRATE  11102
3 2023 CALIFORNIA          6 CHEMICAL, FUNGICIDE          BOSCALID 128008
4 2023 CALIFORNIA          6 CHEMICAL, FUNGICIDE            CAPTAN  81301
5 2023 CALIFORNIA          6 CHEMICAL, FUNGICIDE        CYPRODINIL 288202
6 2023 CALIFORNIA          6 CHEMICAL, FUNGICIDE        FENHEXAMID  90209
   Value    Indicator           Measurement Crop_Status
1  0.326 APPLICATIONS LB / ACRE / YEAR, AVG     BEARING
2  0.093 APPLICATIONS LB / ACRE / YEAR, AVG     BEARING
3  0.885 APPLICATIONS LB / ACRE / YEAR, AVG     BEARING
4 15.932 APPLICATIONS LB / ACRE / YEAR, AVG     BEARING
5  0.872 APPLICATIONS LB / ACRE / YEAR, AVG     BEARING
6  0.753 APPLICATIONS LB / ACRE / YEAR, AVG     BEARING</code></pre>
</div>
</div>
<p>#The data set now is perfectly cleaned and time for some analysis</p>
<div style="page-break-after: always;"></div>
<p>##Some EDAs</p>
<p>#We want to find the most popular fungicide for both states, let’s focus on 2023 data</p>
<section id="fungicide-comparison-by-measurement-type2023" class="level2">
<h2 class="anchored" data-anchor-id="fungicide-comparison-by-measurement-type2023">Fungicide Comparison by Measurement Type(2023)</h2>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="strawberryfungicide_files/figure-html/2023fungicide%20LB/ACRE/YEAR,%20avg%20plot-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>This bar chart compares the average fungicide application rate (in pounds per acre per year) across different active ingredients in California and Florida.</p>
<p>Sulfur stands out overwhelmingly, with an average rate near 40 lb/acre/year in California — far higher than any other fungicide.</p>
<p>Captan and Thiram follow, both above 10 lb/acre/year, and are used in both states.</p>
<p>All other fungicides (e.g., Boscalid, Fludioxonil, Fenhexamid) show application rates below 2 lb/acre/year, indicating much lighter use.</p>
<p>Florida’s bars appear shorter for most fungicides, suggesting lower per-acre application intensity compared to California.</p>
<div style="page-break-after: always;"></div>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="strawberryfungicide_files/figure-html/2023fungicide%20PCT%20of%20area%20bearing,%20avg%20plot-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Both states treat over 90% of the area with several fungicides, notably Captan, Fludioxonil, and Trifloxystrobin, suggesting these are key products for disease management.</p>
<p>Sulfur and Cyprodinil also cover more than 70% of the area in California.</p>
<p>A few fungicides (e.g., Boscalid, Azoxystrobin) have notably lower coverage (&lt;30%), implying selective or limited usage.</p>
<p>Overall, Florida and California have similar fungicide portfolios, but Florida exhibits slightly higher treated percentages for the top few fungicides.</p>
<p>#Sulfur,Captan and Thiram are the top 3 fungicide used in both California and Florida</p>
<div style="page-break-after: always;"></div>
<p>##Now we want to find out the trends of these 3 fungicides for 2018-2023</p>
<p>#In California</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="strawberryfungicide_files/figure-html/unnamed-chunk-5-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Figure X shows the temporal trend of average fungicide application rates (in lb/acre/year) for three major active ingredients — Sulfur, Captan, and Thiram — in California strawberry production from 2018 to 2023.</p>
<p>Sulfur consistently exhibits the highest application rate among the three, with a clear increasing trend over time. The rate rose sharply from approximately 13 lb/acre in 2018 to nearly 40 lb/acre in 2023, suggesting a growing reliance on sulfur-based products.</p>
<p>Captan maintained a moderate but steady upward trend, increasing from about 6 lb/acre to 15 lb/acre, reflecting stable and continued use in integrated disease management.</p>
<p>Thiram, while used at much lower rates overall, also shows a mild increase since 2021, likely indicating its continued but targeted role in specific disease control.</p>
<p>Overall, the figure indicates that while sulfur remains the dominant fungicide by application rate, captan and thiram are complementary components of California’s fungicide regimen. The sharp rise of sulfur use in 2023 may be linked to fungicide resistance management strategies or shifts in pest pressure under changing environmental conditions.</p>
<div style="page-break-after: always;"></div>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="strawberryfungicide_files/figure-html/unnamed-chunk-6-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Figure X illustrates the percentage of strawberry-bearing area treated with three major fungicides — Captan, Sulfur, and Thiram — between 2018 and 2023 in California.</p>
<p>Sulfur maintains the highest overall treated area coverage throughout the period, fluctuating between 70–90%, indicating its broad and consistent use for disease control.</p>
<p>Captan shows greater year-to-year variation, dropping after 2019 but sharply increasing again by 2023 to over 90%, suggesting changes in treatment intensity or replacement cycles.</p>
<p>Thiram demonstrates the lowest coverage in early years but shows a steady rise after 2021, reflecting renewed or expanded use in certain disease management strategies.</p>
<p>In general, all three fungicides maintain high levels of treated area, showing that multi-product programs are a core feature of California’s strawberry disease management system.</p>
<div style="page-break-after: always;"></div>
<p>#In Florida</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="strawberryfungicide_files/figure-html/unnamed-chunk-7-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Figure X presents the temporal trend of fungicide application rates for Captan and Thiram in Florida strawberry production from 2018 to 2023.</p>
<p>Both fungicides show a notable rise in usage from 2018 to 2021, with Captan increasing from about 9 lb/acre to over 21 lb/acre and Thiram from roughly 6 lb/acre to nearly 22 lb/acre. This pattern suggests intensified fungicide application in response to higher disease pressure or increased acreage during this period.</p>
<p>After 2021, both fungicides display a downward trend, with average rates declining by roughly 40–50% by 2023, which may indicate improved pest management efficiency, reduced disease severity, or substitution with other active ingredients.</p>
<p>Interestingly, the gap between Captan and Thiram narrows over time, implying greater overlap in their functional roles or alternating use as resistance management strategies.</p>
<p>Overall, the figure reflects a cycle of intensified use followed by decline, characteristic of adaptive chemical management practices in Florida’s strawberry production system.</p>
<div style="page-break-after: always;"></div>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="strawberryfungicide_files/figure-html/unnamed-chunk-8-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Figure X shows the percentage of strawberry acreage in Florida treated with Captan and Thiram from 2018 to 2023.</p>
<p>Captan demonstrates a distinct U-shaped trend — starting at a very high coverage level in 2018 (about 95%), declining steadily to its lowest point in 2021 (~60%), and then sharply recovering to near full coverage again by 2023. This pattern may suggest temporary substitution with alternative fungicides during mid-years, followed by reinstatement due to effectiveness or market preference.</p>
<p>Thiram, in contrast, shows a steady and moderate increase throughout the same period, rising from around 35% to over 60%. The gradual rise implies expanding adoption or complementary use alongside Captan.</p>
<p>By 2021–2023, both fungicides converge around similar coverage levels (~60%), reflecting a potential balancing strategy to diversify disease control and delay resistance development.</p>
<p>Overall, Florida’s treated area trends highlight a dynamic adjustment in fungicide usage — where Captan remains dominant but Thiram’s role has steadily expanded, possibly as part of integrated pest management (IPM) efforts.</p>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>