---
title: "Strawberry"
format: html
editor: visual
---


```{r}
#| label: load libraries and set options
#| warning: false
#| message: false

library(knitr)  
library(kableExtra)
library(tidyverse)
library(stringr)

```

```{r}
#| label: read data - glimpse 

strawberry <- read_csv("strawberry_10Oct25.csv", col_names = TRUE)

glimpse(strawberry)
##Oct25
```

```{r}
#| label: explore organization 1 


## Is every line associated with a state?

state_all <- strawberry |> distinct(State)

state_all1 <- strawberry |> group_by(State) |> count()

## every row is associated with a state

if(sum(state_all1$n) == dim(strawberry)[1]){print("Yes every row in the data is associated with a state.")}

## rm(state_all, state_all1)

```


```{r}
#|label: function def - drop 1-item columns

### write your function
drop_one_value_col <- function(df){
  drop = NULL
  for(i in 1:dim(df)[2]){
    if((df%>% distinct(df[,i])%>%count()) == 1){
      drop = c(drop,i)
    }
  }
  if(is.null(drop)){return("none")}else{
    print("col dropped:")
    print(colnames(df)[drop])
    strawberry<- df[,-1*drop]
  }
}

strawberry <- drop_one_value_col(strawberry)
## use the function

## strawberry <- drop_one_value_col(strawberry)

## drop_one_value_col(strawberry)

```

```{r}
strawb_census <- strawberry %>% 
  filter(Program == "CENSUS")

#census_data_items <- strawb_census %>% distinct('Data Item')

strawb_survey <- strawberry %>% 
  filter(Program == "SURVEY")
#surv_data_item <- strawb_survey |> distinct()

strawb_survey$'Data Item'<- str_replace(strawb_survey$`Data Item`,", ","\ -\ ")

```

## separate composite columns

```{r}
strawberry <- strawberry %>%
  separate_wider_delim(cols = 'Data Item',
                       delim = ",",
                       names = c("Fruit","Category","Item","Metric"),
                       too_many = "error",
                       too_few = "align_start")
```




```{r}
data  <- read.csv("strawberry1017.csv")
data <- drop_one_value_col(data)

fdata <- data %>%
  filter(Domain == "CHEMICAL, FUNGICIDE" )%>%
  mutate(unit = str_extract(Data.Item, "MEASURED IN.*")) %>%
  mutate(Data.Item = str_remove(Data.Item, " -?MEASURED IN.*")) %>%
  mutate(Data.Item = gsub(",", " -", Data.Item))%>%
  separate_wider_delim(Data.Item, delim = " - ",
                       names = c("data1","data2","data3"),
                       too_many = "merge",
                       too_few = "align_start") %>%
  select(-data3)

clean_data <- data %>%
  # 1️⃣ 保留目标 Domain
  filter(Domain == "CHEMICAL, FUNGICIDE") %>%
  
  # 2️⃣ 提取单位部分
  mutate(unit = str_extract(Data.Item, "(?<=MEASURED IN ).*")) %>%
  mutate(Data.Item = str_remove(Data.Item, " -?MEASURED IN .*")) %>%

  # 3️⃣ 统一分隔符（把逗号换成 -）
  mutate(Data.Item = gsub(",", " - ", Data.Item)) %>%
  
  # 4️⃣ 拆分主要结构
  separate_wider_delim(Data.Item,
                       delim = " - ",
                       names = c("crop","stage","variable"),
                       too_few = "align_start",
                       too_many = "merge") %>%
  
  # 5️⃣ 再进一步整理、去除多余空格
  mutate(across(everything(), ~str_trim(.)))

```










